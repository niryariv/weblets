{% extends "layout.html" %}

	{% block head %}
	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js" type="text/javascript"></script>
	<script src="/static/js/jquery.textarea.js" type="text/javascript"></script>
  <script src="/static/js/codemirror/codemirror.js" type="text/javascript"></script>

	<!-- CodeMirror -->
  <style type="text/css">
    .CodeMirror-line-numbers {
      width: 2.2em;
      color: #aaa;
      background-color: #eee;
      text-align: right;
      padding: .4em;
      margin: 0;
      font-family: monospace;
      font-size: 10pt;
      line-height: 1.1em;
    }
  </style>

	<script type="text/javascript">

	function save(callback_func) {
		
	{% if can_edit %} 
		
		$.post( '/_source/{{script.name}}', 
						{ 
								code: editor.getCode(), //$("#code").val(), 
								docs: $("#docs").val(),
								listable: $("#listable").is(':checked'),
								description: $("#description").val(),
								
								_method: 'put', 
								format: 'xhr'
						},
						callback_func
						);
		
	{% else %}
		
		callback_func();
		
	{% endif %}
	}
	
	function run_get() {
		$.ajax({
					url : '/{{script.name}}', 
					type: 'GET',
					data: $("#params").val(), 
					dataType: 'text',
					complete: function(xhr, status){ display_test(xhr, status) }
					})
	}
	var editor;
	
	function display_test(xhr, status){
		$("#test_results").html('<textarea cols="120" rows="30">' + xhr.responseText + '</textarea>')
	}
	
	$(document).ready(function(){
		
		// enable tabs inside textareas
		$("textarea").tabby();
		
		// save docs & code
		$("#save").click(function (){
			save();
		});

		// save and execute
		$("#run").click(function () { 
			save( function()(window.location = "/{{script.name}}?" + $("#params").val() ));
		});

		// test run locally
		$("#test").click(function () { 
			save(function ()(run_get()) );
		});

		editor = CodeMirror.fromTextArea('code', {
			{% if not can_edit %} readonly: true, {% endif %}
			parserfile: ["parsepython.js"],
			stylesheet: "/static/css/pythoncolors.css",
			path: "/static/js/codemirror/",
			lineNumbers: true,
			textWrapping: false,
			indentUnit: 4,
			width: "600px", height: "400px",
			parserConfig: {'pythonVersion': 2, 'strictErrors': true}
    });

	});

	</script>
	{% endblock %}
	
	{% block body %}

<form action="/_source/{{script.name}}" method="post" name="info">
	
	<table align="center" width="80%" border="1" cellpadding="0"> <!-- free yourselves from CSS! -->
		<tr>
			<td colspan="3">
				<span style="font-size: 20px"><tt>{{script.name}}</tt></span>&nbsp;&nbsp;&nbsp;&nbsp;
				{% if logged_in %}
					<input type="text" size="60" id="description" value="{{ script.description }}" name="description">
				{% else %}
					{{script.description}}
				{% endif %}
					&nbsp;&nbsp;&nbsp;&nbsp;
					<input type="checkbox" id="listable" name="listable" {% if script.listable %}checked{% else %}unchecked{% endif %} />Listable 
				<br /><br />
			</td>
		</tr>
		<tr>
			<td align="left">
				<input type="hidden" name="_method" value="put" />
				<textarea name="code" id="code">{{script.code}}</textarea>
			</td>
			<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
			<td valign="top">
				{% if can_edit %}
					<textarea name="docs" id="docs" cols="75" rows="30">{{script.docs}}</textarea>
				{% else %}
					{{ textile_docs }}
				{% endif %}
			</td>
		</tr>
		<tr>
			<td align="center" colspan="3">
				{% if can_edit %}<input type="button" value="Save" id="save" />{% endif %}
				&nbsp;&nbsp;&nbsp;&nbsp;
				<input type="button" value="Run" id="run" />
				&nbsp;&nbsp;&nbsp;&nbsp;
				<tt>GET /{{script.name}}?</tt><input type="text" size="20" id="params">
				<input type="button" value="Test" id="test" />
				<br />
				<div id="test_results"></div>
			</td>
		</tr>
	</table>
	
	
</form>
{% endblock %}